# 局域网导入功能技术文档

## 1. 需求分析

### 1.1 问题描述
当前导入功能在电脑上使用方便，但在手机上操作不便。用户希望通过手机操作后，PC端访问局域网地址，在该地址上上传文件，解析后将数据导入手机端的IndexedDB。

### 1.2 需求目标
- 实现手机端与PC端的局域网通信
- 允许PC端通过浏览器访问手机端提供的Web界面
- 支持PC端上传.apkg文件到手机端
- 手机端解析文件并将数据导入IndexedDB
- 提供导入进度和状态反馈

## 2. 技术可行性分析

### 2.1 技术栈支持
- 当前项目使用React + Umi + TypeScript + antd-mobile
- 已实现.apkg文件解析和IndexedDB存储功能
- 可扩展支持HTTP服务器和WebSocket通信

### 2.2 实现方案比较

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| HTTP服务器 | 实现简单，浏览器直接访问，无需额外客户端 | 安全性较低，需要手动输入IP地址 | 简单易用，适合大多数场景 |
| WebSocket | 实时通信，双向数据传输，适合进度反馈 | 实现复杂，需要处理连接管理 | 对实时性要求高的场景 |
| WebRTC | 点对点通信，无需服务器中转 | 实现复杂，浏览器兼容性问题 | 对安全性要求高的场景 |

### 2.3 推荐方案
**推荐使用HTTP服务器方案**，因为：
- 实现相对简单，可复用现有代码
- 浏览器直接访问，无需额外客户端
- 适合文件上传和进度反馈场景
- 学习成本低，易于维护

## 3. 详细设计

### 3.1 系统架构

```
┌─────────────────┐       ┌─────────────────┐
│   PC浏览器      │       │   手机浏览器     │
│   (客户端)       │       │   (服务器端)     │
└─────────┬───────┘       └─────────┬───────┘
          │                         │
          │  HTTP请求 (上传文件)     │
          └────────────────────────►│
          │                         │
          │  解析.apkg文件           │
          │                         │
          │  导入IndexedDB          │
          │                         │
          │  HTTP响应 (进度/结果)    │
          ◄────────────────────────┘
```

### 3.2 核心功能模块

#### 3.2.1 HTTP服务器模块
- 负责在手机端启动HTTP服务器
- 提供文件上传接口
- 提供Web界面访问
- 处理跨域请求

#### 3.2.2 文件上传模块
- 接收PC端上传的.apkg文件
- 验证文件格式和大小
- 保存临时文件

#### 3.2.3 解析导入模块
- 复用现有ApkgImporter类
- 解析.apkg文件
- 将数据导入IndexedDB
- 提供进度回调

#### 3.2.4 Web界面模块
- 提供PC端访问的上传界面
- 显示导入进度和状态
- 提供操作指引

### 3.3 数据流程

1. 手机端启动HTTP服务器，生成局域网访问地址
2. 用户在PC端浏览器输入该地址
3. PC端选择并上传.apkg文件
4. 手机端接收文件并开始解析
5. 手机端将解析后的数据导入IndexedDB
6. 导入完成后，PC端显示成功信息
7. 手机端关闭HTTP服务器（可选）

### 3.4 关键技术点

#### 3.4.1 HTTP服务器实现
- 使用`http-server`或自定义HTTP服务器
- 监听手机的局域网IP地址
- 提供静态文件服务和API接口

#### 3.4.2 文件上传处理
- 使用`multer`或自定义文件上传处理
- 支持大文件上传（分块上传可选）
- 临时文件管理

#### 3.4.3 进度反馈机制
- 使用WebSocket或HTTP长轮询
- 实时更新导入进度
- 支持断点续传（可选）

#### 3.4.4 安全性考虑
- 限制访问IP（仅允许局域网访问）
- 实现简单的身份验证
- 上传文件类型验证
- 临时文件自动清理

## 4. 实现步骤

### 4.1 第一步：添加HTTP服务器依赖
- 安装`http-server`或类似库
- 配置开发和生产环境

### 4.2 第二步：实现HTTP服务器功能
- 创建HTTP服务器类
- 实现文件上传接口
- 配置静态文件服务

### 4.3 第三步：开发PC端Web界面
- 创建上传页面组件
- 实现文件选择和上传功能
- 添加进度显示组件

### 4.4 第四步：集成现有解析导入功能
- 复用ApkgImporter类
- 实现文件解析和数据导入
- 添加进度回调

### 4.5 第五步：添加手机端控制界面
- 创建HTTP服务器控制页面
- 显示局域网访问地址
- 提供启动/停止服务器功能
- 显示导入状态和日志

### 4.6 第六步：测试和优化
- 测试不同设备和浏览器
- 优化大文件处理性能
- 完善错误处理和用户提示

## 5. 代码结构设计

```
src/
├── services/
│   ├── import/
│   │   ├── ApkgImporter.ts      # 现有解析导入类
│   │   └── LanImportService.ts  # 局域网导入服务
│   └── http-server/
│       ├── HttpServer.ts        # HTTP服务器实现
│       └── routes/
│           ├── upload.ts        # 文件上传路由
│           └── status.ts        # 状态查询路由
├── pages/
│   ├── import/
│   │   ├── index.tsx            # 现有导入页面
│   │   └── lan-import.tsx       # 局域网导入控制页面
│   └── lan-upload/              # PC端访问的上传页面
│       └── index.tsx
└── utils/
    └── network.ts               # 网络相关工具函数
```

## 6. 技术选型

| 技术/库 | 用途 | 版本 |
|---------|------|------|
| http-server | HTTP服务器 | ^14.1.1 |
| multer | 文件上传处理 | ^1.4.5-lts.1 |
| socket.io | 实时通信（可选） | ^4.7.5 |
| react-dropzone | 文件上传组件 | ^14.2.3 |
| antd-mobile | UI组件库 | ^5.41.1 |

## 7. 安全性考虑

1. **访问控制**：仅允许局域网IP访问HTTP服务器
2. **文件验证**：只接受.apkg文件，验证文件格式和大小
3. **临时文件管理**：导入完成后自动删除临时文件
4. **身份验证**：添加简单的密码验证机制
5. **HTTPS支持**：可选，提高安全性

## 8. 性能优化

1. **分块上传**：支持大文件分块上传
2. **异步处理**：使用异步IO和Worker线程处理文件解析
3. **内存管理**：优化大文件解析时的内存使用
4. **缓存机制**：缓存常用数据，提高访问速度

## 9. 兼容性考虑

1. **浏览器兼容性**：支持Chrome、Firefox、Safari等主流浏览器
2. **设备兼容性**：支持iOS和Android设备
3. **网络兼容性**：支持不同局域网环境

## 10. 测试计划

### 10.1 功能测试
- HTTP服务器启动和停止
- PC端访问手机端局域网地址
- 文件上传功能
- 解析和导入功能
- 进度显示功能

### 10.2 性能测试
- 大文件导入性能
- 多文件并发导入
- 长时间运行稳定性

### 10.3 兼容性测试
- 不同浏览器测试
- 不同设备测试
- 不同网络环境测试

## 11. 部署和使用

### 11.1 部署方式
- 集成到现有项目中，作为一个功能模块
- 无需额外的服务器部署

### 11.2 使用流程
1. 手机端打开应用，进入局域网导入页面
2. 点击"启动服务器"按钮，生成局域网访问地址
3. PC端浏览器输入该地址
4. PC端选择.apkg文件并点击"上传"
5. 等待导入完成，查看导入结果
6. 手机端关闭服务器

## 12. 风险评估

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 安全性问题 | 数据泄露 | 限制局域网访问，添加身份验证 |
| 性能问题 | 导入缓慢 | 优化解析算法，使用异步处理 |
| 兼容性问题 | 部分设备无法使用 | 测试多种设备和浏览器，提供降级方案 |
| 易用性问题 | 用户不知道如何使用 | 提供详细的操作指引和帮助文档 |

## 13. 结论

该需求是可以实现的，推荐使用HTTP服务器方案。通过在手机端启动HTTP服务器，提供PC端访问的Web界面，实现文件上传和数据导入功能。该方案实现简单，易用性好，适合大多数用户场景。

## 14. 后续优化方向

1. 支持更多文件格式导入
2. 实现断点续传功能
3. 添加数据预览功能
4. 支持批量导入和导出
5. 优化用户界面和操作流程
6. 添加数据同步功能

## 15. 参考资料

- [http-server文档](https://www.npmjs.com/package/http-server)
- [multer文档](https://www.npmjs.com/package/multer)
- [socket.io文档](https://socket.io/docs/v4/)
- [WebRTC文档](https://webrtc.org/getting-started/overview)
- [IndexedDB文档](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
